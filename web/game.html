<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>sket.io</title>

        <!-- css files -->
        <link rel="stylesheet" href="css/game.css">
        <link rel="stylesheet" href="css/progressbar.css">
    </head>
    <body>
        <div class="container">
            <div class="sket-game-side" id="left-side">
                <div id="player-1">
                    <div class="sket-player">

                    </div>
                    <div class="sket-score">

                    </div>
                </div>
                <div id="player-2">
                    <div class="sket-score">

                    </div>
                    <div class="sket-player">

                    </div>
                </div>
            </div>
            <div class="stage" id="game-area">
                <div id="sket-round-info">
                    <h3>1/10 라운드</h3>
                </div>

                <div id="sketch-area">
                    <canvas id="canvas" width="490" height="220" style="border:1px solid #000000;"></canvas>
                </div>

                <div id="time-progress-bar">
                    <div class="progressbar progressbar-blue">
                        <div class="progressbar-inner"></div>
                    </div>
                </div>

                <div id="sket-chatting">
                    chatting
                </div>
            </div>

            <div class="sket-game-side" id="right-side">
                <div id="player-3">
                    <div class="sket-player">

                    </div>
                    <div class="sket-score">

                    </div>
                </div>
                <div id="player-4">
                    <div class="sket-score">

                    </div>
                    <div class="sket-player">

                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script>
            // 웹 소켓
            // 구현 필요  webSocket.close();
            var webSocket = new WebSocket('ws://localhost:8080/test');
            webSocket.onopen = function () {
                console.log("서버 연결ddd");
            };
            webSocket.onclose = function () {
                console.log("서버 종료");
            };
            webSocket.onerror = function () {
                console.log("서버 에러")
            };
            webSocket.onmessage = function (msg) {
                console.log("서버로부터 받음:  " + msg.data);
            };


            var context = document.getElementById('canvas').getContext("2d");
            var clickX = new Array();
            var clickY = new Array();
            var clickDrag = new Array();
            var paint;
            var msg = {
                type: "getCanvasData",
                clickX: clickX,
                clickY:   clickY,
                clickDrag: clickDrag
            };

            function addClick(x, y, dragging)
            {
                clickX.push(x);
                clickY.push(y);
                clickDrag.push(dragging);
            }

            $('#canvas').mousedown(function(e){
                var mouseX = e.pageX - this.offsetLeft;
                var mouseY = e.pageY - this.offsetTop;

                paint = true;
                addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
                webSocket.send(msg);
                redraw();
            });

            $('#canvas').mousemove(function(e){
                if(paint){
                    addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
                    webSocket.send(msg);
                    redraw();
                }
            });

            $('#canvas').mouseup(function(e){
                paint = false;
            });

            $('#canvas').mouseleave(function(e){
                paint = false;
            });

            function redraw(){
                context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas

                context.strokeStyle = "#df4b26";
                context.lineJoin = "round";
                context.lineWidth = 5;

                for(var i=0; i < clickX.length; i++) {
                    context.beginPath();
                    if(clickDrag[i] && i){
                        context.moveTo(clickX[i-1], clickY[i-1]);
                    }else{
                        context.moveTo(clickX[i]-1, clickY[i]);
                    }
                    context.lineTo(clickX[i], clickY[i]);
                    context.closePath();
                    context.stroke();
                }
            }



        </script>
    </body>
</html>
